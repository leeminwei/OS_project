# è®€è€…-å¯«è€…å•é¡Œå¯¦ç¿’ä½œæ¥­ Makefile
# åŸºæ–¼æ¢ä»¶è®Šæ•¸çš„åŒæ­¥æ©Ÿåˆ¶å¯¦ä½œ

# ç·¨è­¯å™¨è¨­å®š
CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -pthread -g -O0
LDFLAGS = -pthread

# æª”æ¡ˆå®šç¾©
HEADER = reader_writer.h
MAIN_SRC = reader_writer.c
TEST_SRC = test_reader_writer.c
MAIN_OBJ = reader_writer.o
TEST_OBJ = test_reader_writer.o

# ç›®æ¨™æª”æ¡ˆ
MAIN_TARGET = reader_writer
TEST_TARGET = test_reader_writer

# é è¨­ç›®æ¨™
.PHONY: all clean test help debug release

all: $(MAIN_TARGET) $(TEST_TARGET)

# ä¸»ç¨‹å¼ç·¨è­¯
$(MAIN_TARGET): $(MAIN_OBJ)
	@echo "ğŸ”¨ é€£çµä¸»ç¨‹å¼..."
	$(CC) $(LDFLAGS) -o $@ $^
	@echo "âœ… ä¸»ç¨‹å¼ç·¨è­¯å®Œæˆ: $(MAIN_TARGET)"

$(MAIN_OBJ): $(MAIN_SRC) $(HEADER)
	@echo "ğŸ”¨ ç·¨è­¯ä¸»ç¨‹å¼..."
	$(CC) $(CFLAGS) -c $< -o $@

# æ¸¬è©¦ç¨‹å¼ç·¨è­¯  
$(TEST_TARGET): $(TEST_OBJ) reader_writer_lib.o
	@echo "ğŸ”¨ é€£çµæ¸¬è©¦ç¨‹å¼..."
	$(CC) $(LDFLAGS) -o $@ $^
	@echo "âœ… æ¸¬è©¦ç¨‹å¼ç·¨è­¯å®Œæˆ: $(TEST_TARGET)"

$(TEST_OBJ): $(TEST_SRC) $(HEADER)
	@echo "ğŸ”¨ ç·¨è­¯æ¸¬è©¦ç¨‹å¼..."
	$(CC) $(CFLAGS) -c $< -o $@

# å»ºç«‹å‡½å¼åº«ç‰ˆæœ¬ï¼ˆä¸åŒ…å«mainå‡½æ•¸ï¼‰
reader_writer_lib.o: $(MAIN_SRC) $(HEADER)
	@echo "ğŸ”¨ ç·¨è­¯å‡½å¼åº«..."
	$(CC) $(CFLAGS) -DLIB_BUILD -c $< -o $@

# åŸ·è¡Œæ¸¬è©¦
test: $(TEST_TARGET)
	@echo "ğŸ§ª åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦..."
	./$(TEST_TARGET)
	@echo ""

# åŸ·è¡Œå£“åŠ›æ¸¬è©¦
stress-test: $(TEST_TARGET)
	@echo "ğŸ§ª åŸ·è¡Œå£“åŠ›æ¸¬è©¦..."
	./$(TEST_TARGET) --stress

# åŸ·è¡Œä¸»ç¨‹å¼ï¼ˆé è¨­åƒæ•¸ï¼‰
run: $(MAIN_TARGET)
	@echo "ğŸš€ åŸ·è¡Œä¸»ç¨‹å¼ï¼ˆé è¨­åƒæ•¸ï¼‰..."
	./$(MAIN_TARGET)

# åŸ·è¡Œä¸»ç¨‹å¼ï¼ˆè‡ªè¨‚åƒæ•¸ï¼‰
run-custom: $(MAIN_TARGET)
	@echo "ğŸš€ åŸ·è¡Œä¸»ç¨‹å¼ï¼ˆè‡ªè¨‚åƒæ•¸ï¼‰..."
	@echo "æ ¼å¼: ./$(MAIN_TARGET) [è®€è€…æ•¸] [å¯«è€…æ•¸] [æ“ä½œæ¬¡æ•¸] [è®€è€…å»¶é²ms] [å¯«è€…å»¶é²ms]"
	@read -p "è®€è€…æ•¸é‡ (é è¨­3): " readers && \
	 read -p "å¯«è€…æ•¸é‡ (é è¨­2): " writers && \
	 read -p "æ“ä½œæ¬¡æ•¸ (é è¨­3): " ops && \
	 read -p "è®€è€…å»¶é²ms (é è¨­100): " r_delay && \
	 read -p "å¯«è€…å»¶é²ms (é è¨­200): " w_delay && \
	 ./$(MAIN_TARGET) $${readers:-3} $${writers:-2} $${ops:-3} $${r_delay:-100} $${w_delay:-200}

# é™¤éŒ¯ç‰ˆæœ¬
debug: CFLAGS += -DDEBUG -g3 -O0
debug: clean $(MAIN_TARGET) $(TEST_TARGET)
	@echo "ğŸ› é™¤éŒ¯ç‰ˆæœ¬ç·¨è­¯å®Œæˆ"

# ç™¼å¸ƒç‰ˆæœ¬
release: CFLAGS += -O2 -DNDEBUG
release: clean $(MAIN_TARGET) $(TEST_TARGET)
	@echo "ğŸš€ ç™¼å¸ƒç‰ˆæœ¬ç·¨è­¯å®Œæˆ"

# ä½¿ç”¨valgrindæª¢æŸ¥è¨˜æ†¶é«”æ´©æ¼
memcheck: $(MAIN_TARGET) $(TEST_TARGET)
	@echo "ğŸ” ä½¿ç”¨valgrindæª¢æŸ¥è¨˜æ†¶é«”..."
	@if command -v valgrind >/dev/null 2>&1; then \
		echo "æª¢æŸ¥ä¸»ç¨‹å¼:"; \
		valgrind --leak-check=full --show-leak-kinds=all \
			--track-origins=yes ./$(MAIN_TARGET) 2 2 2 50 50; \
		echo "æª¢æŸ¥æ¸¬è©¦ç¨‹å¼:"; \
		valgrind --leak-check=full --show-leak-kinds=all \
			--track-origins=yes ./$(TEST_TARGET); \
	else \
		echo "âš ï¸  valgrind æœªå®‰è£ï¼Œè·³éè¨˜æ†¶é«”æª¢æŸ¥"; \
	fi

# ä½¿ç”¨gdbé™¤éŒ¯
gdb: $(MAIN_TARGET)
	@echo "ğŸ› å•Ÿå‹•gdbé™¤éŒ¯å™¨..."
	gdb ./$(MAIN_TARGET)

# ç·¨è­¯è³‡è¨Š
info:
	@echo "ğŸ“‹ ç·¨è­¯è³‡è¨Š:"
	@echo "ç·¨è­¯å™¨: $(CC)"
	@echo "ç·¨è­¯é¸é …: $(CFLAGS)"
	@echo "é€£çµé¸é …: $(LDFLAGS)"
	@echo "åŸå§‹æª”: $(MAIN_SRC) $(TEST_SRC)"
	@echo "æ¨™é ­æª”: $(HEADER)"
	@echo "ç›®æ¨™æª”: $(MAIN_TARGET) $(TEST_TARGET)"

# ç¨‹å¼ç¢¼çµ±è¨ˆ
stats:
	@echo "ğŸ“Š ç¨‹å¼ç¢¼çµ±è¨ˆ:"
	@echo "æ¨™é ­æª”æ¡ˆ:"
	@wc -l $(HEADER)
	@echo "ä¸»ç¨‹å¼æª”æ¡ˆ:"
	@wc -l $(MAIN_SRC)
	@echo "æ¸¬è©¦æª”æ¡ˆ:"
	@wc -l $(TEST_SRC)
	@echo "ç¸½è¨ˆ:"
	@wc -l $(HEADER) $(MAIN_SRC) $(TEST_SRC) | tail -1

# æª¢æŸ¥ç¨‹å¼ç¢¼é¢¨æ ¼
style-check:
	@echo "ğŸ¨ æª¢æŸ¥ç¨‹å¼ç¢¼é¢¨æ ¼..."
	@if command -v clang-format >/dev/null 2>&1; then \
		echo "ä½¿ç”¨clang-formatæª¢æŸ¥é¢¨æ ¼:"; \
		clang-format --dry-run --Werror $(MAIN_SRC) $(TEST_SRC) $(HEADER) 2>&1 || \
		echo "âš ï¸  ç¨‹å¼ç¢¼é¢¨æ ¼éœ€è¦èª¿æ•´"; \
	else \
		echo "âš ï¸  clang-format æœªå®‰è£ï¼Œè·³éé¢¨æ ¼æª¢æŸ¥"; \
	fi

# è‡ªå‹•æ ¼å¼åŒ–ç¨‹å¼ç¢¼
format:
	@echo "ğŸ¨ æ ¼å¼åŒ–ç¨‹å¼ç¢¼..."
	@if command -v clang-format >/dev/null 2>&1; then \
		clang-format -i $(MAIN_SRC) $(TEST_SRC) $(HEADER); \
		echo "âœ… ç¨‹å¼ç¢¼æ ¼å¼åŒ–å®Œæˆ"; \
	else \
		echo "âš ï¸  clang-format æœªå®‰è£ï¼Œç„¡æ³•æ ¼å¼åŒ–"; \
	fi

# å®Œæ•´æ¸¬è©¦æµç¨‹
full-test: clean all test stress-test
	@echo "ğŸ‰ å®Œæ•´æ¸¬è©¦æµç¨‹å®Œæˆ!"

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ç·¨è­¯æª”æ¡ˆ..."
	rm -f $(MAIN_OBJ) $(TEST_OBJ) reader_writer_lib.o
	rm -f $(MAIN_TARGET) $(TEST_TARGET)
	rm -f core vgcore.*
	@echo "âœ… æ¸…ç†å®Œæˆ"

# èªªæ˜
help:
	@echo "ğŸ“– å¯ç”¨çš„Makefileç›®æ¨™:"
	@echo ""
	@echo "ğŸ”¨ ç·¨è­¯ç›¸é—œ:"
	@echo "  all          - ç·¨è­¯æ‰€æœ‰ç¨‹å¼ï¼ˆé è¨­ï¼‰"
	@echo "  debug        - ç·¨è­¯é™¤éŒ¯ç‰ˆæœ¬"
	@echo "  release      - ç·¨è­¯ç™¼å¸ƒç‰ˆæœ¬"
	@echo "  clean        - æ¸…ç†ç·¨è­¯æª”æ¡ˆ"
	@echo ""
	@echo "ğŸ§ª æ¸¬è©¦ç›¸é—œ:"
	@echo "  test         - åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦"
	@echo "  stress-test  - åŸ·è¡Œå£“åŠ›æ¸¬è©¦"
	@echo "  full-test    - åŸ·è¡Œå®Œæ•´æ¸¬è©¦æµç¨‹"
	@echo "  memcheck     - è¨˜æ†¶é«”æ´©æ¼æª¢æŸ¥ï¼ˆéœ€è¦valgrindï¼‰"
	@echo ""
	@echo "ğŸš€ åŸ·è¡Œç›¸é—œ:"
	@echo "  run          - åŸ·è¡Œä¸»ç¨‹å¼ï¼ˆé è¨­åƒæ•¸ï¼‰"
	@echo "  run-custom   - åŸ·è¡Œä¸»ç¨‹å¼ï¼ˆè‡ªè¨‚åƒæ•¸ï¼‰"
	@echo "  gdb          - ä½¿ç”¨gdbé™¤éŒ¯"
	@echo ""
	@echo "ğŸ“Š è³‡è¨Šç›¸é—œ:"
	@echo "  info         - é¡¯ç¤ºç·¨è­¯è³‡è¨Š"
	@echo "  stats        - é¡¯ç¤ºç¨‹å¼ç¢¼çµ±è¨ˆ"
	@echo "  style-check  - æª¢æŸ¥ç¨‹å¼ç¢¼é¢¨æ ¼"
	@echo "  format       - è‡ªå‹•æ ¼å¼åŒ–ç¨‹å¼ç¢¼"
	@echo "  help         - é¡¯ç¤ºæ­¤èªªæ˜"
	@echo ""
	@echo "ğŸ’¡ ç¯„ä¾‹ç”¨æ³•:"
	@echo "  make all && make test       # ç·¨è­¯ä¸¦æ¸¬è©¦"
	@echo "  make run                    # åŸ·è¡Œé è¨­ç¨‹å¼"
	@echo "  make clean && make debug    # æ¸…ç†ä¸¦ç·¨è­¯é™¤éŒ¯ç‰ˆæœ¬"

# é˜²æ­¢makeæŠŠé€™äº›ç•¶ä½œæª”æ¡ˆåç¨±
.PHONY: all clean test stress-test run run-custom debug release memcheck gdb info stats style-check format full-test help 