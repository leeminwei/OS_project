# ç”Ÿç”¢è€…æ¶ˆè²»è€…å•é¡Œ - Makefile
# ç·¨è­¯å™¨è¨­å®š
CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -pthread
LDFLAGS = -pthread

# ç›®æ¨™æª”æ¡ˆ
TARGETS = producer_consumer_custom producer_consumer_system

# ç‰©ä»¶æª”æ¡ˆ
CUSTOM_OBJS = producer_consumer_custom.o custom_semaphore.o utils.o
SYSTEM_OBJS = producer_consumer_system.o utils.o

# é è¨­ç›®æ¨™
all: $(TARGETS)

# ç·¨è­¯è‡ªè£½ä¿¡è™Ÿé‡ç‰ˆæœ¬
producer_consumer_custom: $(CUSTOM_OBJS)
	@echo "ğŸ”§ ç·¨è­¯è‡ªè£½ä¿¡è™Ÿé‡ç‰ˆæœ¬..."
	$(CC) $(LDFLAGS) -o $@ $^
	@echo "âœ… è‡ªè£½ä¿¡è™Ÿé‡ç‰ˆæœ¬ç·¨è­¯å®Œæˆ"

# ç·¨è­¯ç³»çµ±ä¿¡è™Ÿé‡ç‰ˆæœ¬
producer_consumer_system: $(SYSTEM_OBJS)
	@echo "ğŸ”§ ç·¨è­¯ç³»çµ±ä¿¡è™Ÿé‡ç‰ˆæœ¬..."
	$(CC) $(LDFLAGS) -o $@ $^
	@echo "âœ… ç³»çµ±ä¿¡è™Ÿé‡ç‰ˆæœ¬ç·¨è­¯å®Œæˆ"

# ç·¨è­¯ç‰©ä»¶æª”æ¡ˆ
%.o: %.c
	@echo "ğŸ”§ ç·¨è­¯ $<..."
	$(CC) $(CFLAGS) -c $< -o $@

# ç›¸ä¾æ€§è¦å‰‡
producer_consumer_custom.o: producer_consumer_custom.c common.h custom_semaphore.h
producer_consumer_system.o: producer_consumer_system.c common.h
custom_semaphore.o: custom_semaphore.c custom_semaphore.h
utils.o: utils.c common.h

# åŸ·è¡Œæ¸¬è©¦
test: all
	@echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦..."
	@echo "ğŸ“‹ æ¸¬è©¦è‡ªè£½ä¿¡è™Ÿé‡ç‰ˆæœ¬ï¼š"
	./producer_consumer_custom
	@echo ""
	@echo "ğŸ“‹ æ¸¬è©¦ç³»çµ±ä¿¡è™Ÿé‡ç‰ˆæœ¬ï¼š"
	./producer_consumer_system

# åŸ·è¡Œè‡ªè£½ä¿¡è™Ÿé‡ç‰ˆæœ¬
run-custom: producer_consumer_custom
	@echo "ğŸš€ åŸ·è¡Œè‡ªè£½ä¿¡è™Ÿé‡ç‰ˆæœ¬..."
	./producer_consumer_custom

# åŸ·è¡Œç³»çµ±ä¿¡è™Ÿé‡ç‰ˆæœ¬
run-system: producer_consumer_system
	@echo "ğŸš€ åŸ·è¡Œç³»çµ±ä¿¡è™Ÿé‡ç‰ˆæœ¬..."
	./producer_consumer_system

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ç·¨è­¯æª”æ¡ˆ..."
	rm -f $(TARGETS) *.o
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å®‰è£ï¼ˆè¤‡è£½åˆ°ç³»çµ±ç›®éŒ„ï¼Œå¯é¸ï¼‰
install: all
	@echo "ğŸ“¦ å®‰è£ç¨‹å¼åˆ° /usr/local/bin (éœ€è¦ç®¡ç†å“¡æ¬Šé™)..."
	sudo cp $(TARGETS) /usr/local/bin/
	@echo "âœ… å®‰è£å®Œæˆ"

# è§£é™¤å®‰è£
uninstall:
	@echo "ğŸ—‘ï¸ å¾ç³»çµ±ç§»é™¤ç¨‹å¼..."
	sudo rm -f /usr/local/bin/producer_consumer_custom
	sudo rm -f /usr/local/bin/producer_consumer_system
	@echo "âœ… è§£é™¤å®‰è£å®Œæˆ"

# é¡¯ç¤ºå¹«åŠ©è³‡è¨Š
help:
	@echo "ç”Ÿç”¢è€…æ¶ˆè²»è€…å•é¡Œ - Makefile å¹«åŠ©"
	@echo "=================================="
	@echo "å¯ç”¨ç›®æ¨™ï¼š"
	@echo "  all          - ç·¨è­¯æ‰€æœ‰ç¨‹å¼"
	@echo "  clean        - æ¸…ç†ç·¨è­¯æª”æ¡ˆ"
	@echo "  test         - åŸ·è¡Œå…©å€‹ç‰ˆæœ¬çš„æ¸¬è©¦"
	@echo "  run-custom   - åŸ·è¡Œè‡ªè£½ä¿¡è™Ÿé‡ç‰ˆæœ¬"
	@echo "  run-system   - åŸ·è¡Œç³»çµ±ä¿¡è™Ÿé‡ç‰ˆæœ¬"
	@echo "  install      - å®‰è£åˆ°ç³»çµ± (éœ€è¦sudo)"
	@echo "  uninstall    - å¾ç³»çµ±ç§»é™¤ (éœ€è¦sudo)"
	@echo "  help         - é¡¯ç¤ºæ­¤å¹«åŠ©è³‡è¨Š"
	@echo ""
	@echo "ç¯„ä¾‹ï¼š"
	@echo "  make all     # ç·¨è­¯æ‰€æœ‰ç¨‹å¼"
	@echo "  make test    # æ¸¬è©¦å…©å€‹ç‰ˆæœ¬"
	@echo "  make clean   # æ¸…ç†æª”æ¡ˆ"

# é‡å»ºï¼ˆæ¸…ç†å¾Œé‡æ–°ç·¨è­¯ï¼‰
rebuild: clean all
	@echo "âœ… é‡å»ºå®Œæˆ"

# æª¢æŸ¥ç¨‹å¼ç¢¼é¢¨æ ¼ï¼ˆéœ€è¦å®‰è£ clang-formatï¼‰
format:
	@echo "ğŸ¨ æ ¼å¼åŒ–ç¨‹å¼ç¢¼..."
	@if command -v clang-format >/dev/null 2>&1; then \
		clang-format -i *.c *.h; \
		echo "âœ… ç¨‹å¼ç¢¼æ ¼å¼åŒ–å®Œæˆ"; \
	else \
		echo "âš ï¸ clang-format æœªå®‰è£ï¼Œè·³éæ ¼å¼åŒ–"; \
	fi

# æª¢æŸ¥è¨˜æ†¶é«”æ´©æ¼ï¼ˆéœ€è¦å®‰è£ valgrindï¼‰
valgrind-custom: producer_consumer_custom
	@echo "ğŸ” ä½¿ç”¨ Valgrind æª¢æŸ¥è‡ªè£½ä¿¡è™Ÿé‡ç‰ˆæœ¬..."
	@if command -v valgrind >/dev/null 2>&1; then \
		valgrind --leak-check=full --track-origins=yes ./producer_consumer_custom; \
	else \
		echo "âš ï¸ Valgrind æœªå®‰è£ï¼Œè·³éè¨˜æ†¶é«”æª¢æŸ¥"; \
	fi

valgrind-system: producer_consumer_system
	@echo "ğŸ” ä½¿ç”¨ Valgrind æª¢æŸ¥ç³»çµ±ä¿¡è™Ÿé‡ç‰ˆæœ¬..."
	@if command -v valgrind >/dev/null 2>&1; then \
		valgrind --leak-check=full --track-origins=yes ./producer_consumer_system; \
	else \
		echo "âš ï¸ Valgrind æœªå®‰è£ï¼Œè·³éè¨˜æ†¶é«”æª¢æŸ¥"; \
	fi

# å½ç›®æ¨™è²æ˜
.PHONY: all clean test run-custom run-system install uninstall help rebuild format valgrind-custom valgrind-system 